#Activate conda enviornment
conda activate qiime2-amplicon-2024.2

#Files made in windows should be converted correctly and checked for whitespaces
tr ',' '\t' < metadata.csv > metadata.tsv
awk -F',' 'NF != N {print NR, $0}' metadata.tsv

sed 's/"//g' metadata.tsv > metadata_cleaned.tsv

#Reads the minfest files, imports the fastq files and creates an artifact file for downstream processing
qiime tools import --type 'SampleData[PairedEndSequencesWithQuality]' --input-path input_M2B.tsv --output-path sequences.qza --input-format PairedEndFastqManifestPhred33V2

#Creates quality and other statistics from the sequence files
qiime demux summarize --i-data sequences.qza --o-visualization demux.qzv

#DADA2 performs several functions: Quality filtering, Denoising, Dereplication, Merging, Chimera detection
qiime dada2 denoise-paired --i-demultiplexed-seqs sequences.qza --p-trunc-len-f 240 --p-trunc-len-r 240 --output-dir dada2 --verbose

#Visualising denoising stats
qiime metadata tabulate --m-input-file dada2/denoising_stats.qza --o-visualization dada2/denoising-stats.qzv

#
qiime phylogeny align-to-tree-mafft-fasttree --i-sequences dada2/representative_sequences.qza --output-dir tree

qiime empress tree-plot --i-tree tree/rooted_tree.qza --o-visualization tree/empress.qzv

#This produces a table with the read number frequency for each sample with sequencing depths
qiime feature-table summarize --i-table 16S_bacteria_dada2/table.qza --o-visualization table.qzv 

#THE SAMPLING DEPTH SHOULD BE BASED ON THE FREQUENCY DATA FROM THE PREVIOUS STEP TABLE.QZV
#Rarefaction normalises sequencing depth across samples by subsampling reads to a uniform level. lower depth values retain more samples but reduce diversity accuracy.
#Our goal is to retain as many samples as possible.  

qiime diversity core-metrics-phylogenetic --i-table dada2/table.qza --i-phylogeny tree/rooted_tree.qza --p-sampling-depth 3600 --m-metadata-file metadata.tsv --output-dir diversity

qiime diversity alpha-group-significance --i-alpha-diversity diversity/shannon_vector.qza --m-metadata-file metadata.tsv --o-visualization diversity/alpha_groups.qzv

or
qiime tools export --input-path diversity/shannon_vector.qza --output-path exported_alpha_diversity


qiime diversity adonis --i-distance-matrix diversity/weighted_unifrac_distance_matrix.qza --m-metadata-file metadata.tsv --p-formula "site" --p-n-jobs 2 --o-visualization diversity/permanova.qzv

qiime feature-classifier classify-sklearn --i-reads dada2/representative_sequences.qza --i-classifier silva-138-99-nb-classifier.qza --p-n-jobs 2 --o-classification taxa.qza


qiime feature-classifier classify-sklearn --i-reads 16S_dada2/representative_sequences.qza --i-classifier silva-138-99-nb-classifier.qza --p-n-jobs 2 --output-dir 16S_taxa


qiime taxa barplot --i-table 16S_dada2/table.qza --i-taxonomy 16S_taxa/classification.qza --m-metadata-file metadata.tsv --o-visualization 16S_taxa/taxa_barplot.qzv

#Extract taxa table
qiime tools export --input-path 16S_taxa/classification.qza --output-path 16S_taxa









